# EV充电调度仿真系统 - PyQt6版本使用指南

## 📋 目录
1. [系统概述](#系统概述)
2. [安装配置](#安装配置)
3. [功能详解](#功能详解)
4. [界面说明](#界面说明)
5. [操作流程](#操作流程)
6. [高级功能](#高级功能)
7. [故障排除](#故障排除)
8. [开发扩展](#开发扩展)

## 🔋 系统概述

本系统是基于PyQt6开发的电动汽车充电调度仿真平台，相比网页版本具有以下优势：

### ✨ 主要特性
- **原生桌面应用**: 更好的性能和用户体验
- **实时数据可视化**: 高性能图表和动态地图
- **多区域电网建模**: 支持时间-区域负载分析
- **智能调度算法**: 多种调度策略可选
- **丰富的交互功能**: 拖拽、缩放、实时更新
- **数据导出功能**: 支持多种格式导出
- **可扩展架构**: 易于添加新功能

### 🎯 核心功能
1. **实时仿真监控** - 动态显示充电调度过程
2. **多指标分析** - 用户满意度、运营利润、电网友好度
3. **区域负载管理** - 时间-区域电网负载可视化
4. **智能地图显示** - 用户、充电桩实时位置
5. **算法对比分析** - 多种调度算法效果对比
6. **配置管理** - 灵活的参数配置和场景设置

## 🛠 安装配置

### 系统要求
- **操作系统**: Windows 10+, macOS 10.14+, Linux Ubuntu 18+
- **Python版本**: 3.8 或更高版本
- **内存**: 最低 4GB RAM，推荐 8GB+
- **硬盘空间**: 至少 2GB 可用空间

### 安装步骤

#### 1. 环境准备
```bash
# 检查Python版本
python --version

# 创建虚拟环境（推荐）
python -m venv ev_simulation_env

# 激活虚拟环境
# Windows:
ev_simulation_env\Scripts\activate
# macOS/Linux:
source ev_simulation_env/bin/activate
```

#### 2. 下载项目
```bash
# 解压项目文件到工作目录
unzip 核心代码.zip
cd ev_charging_project
```

#### 3. 安装依赖
```bash
# 安装所有依赖包
pip install -r requirements.txt

# 或手动安装核心依赖
pip install PyQt6 pyqtgraph numpy pandas torch
```

#### 4. 启动系统
```bash
# 使用启动脚本（推荐）
python launch_ev_simulation.py

# 或直接启动GUI
python ev_charging_gui.py
```

### 📁 目录结构
```
ev_charging_project/
├── simulation/                    # 仿真核心模块
│   ├── environment.py            # 仿真环境
│   ├── scheduler.py              # 调度器
│   ├── grid_model_enhanced.py    # 增强电网模型
│   ├── metrics.py                # 指标计算
│   ├── user_model.py             # 用户行为模型
│   ├── charger_model.py          # 充电桩模型
│   └── utils.py                  # 工具函数
├── algorithms/                   # 调度算法
│   ├── rule_based.py             # 基于规则
│   ├── coordinated_mas.py        # 协调多智能体
│   ├── marl.py                   # 多智能体强化学习
│   └── uncoordinated.py          # 无序充电
├── ev_charging_gui.py            # 主GUI程序
├── advanced_charts.py           # 高级图表组件
├── app_styles.py                # 样式定义
├── launch_ev_simulation.py      # 启动脚本
├── requirements.txt             # 依赖清单
├── config.json                  # 配置文件
└── README.md                    # 说明文档
```

## 🖥 界面说明

### 主界面布局

```
┌─────────────────────────────────────────────────────────────┐
│  [菜单栏] 文件 仿真 视图 工具 帮助                           │
├─────────────────────────────────────────────────────────────┤
│  [工具栏] ▶️ ⏸️ ⏹️ | ⚙️ | 💾                              │
├──────────────┬──────────────────────────────────────────────┤
│              │  [标签页] 📊图表分析 🗺️实时地图 📋数据详情  │
│   [控制面板]  │                                              │
│              │                                              │
│   [实时指标]  │          [主要内容区域]                     │
│              │                                              │
│   [快速配置]  │                                              │
│              │                                              │
├──────────────┴──────────────────────────────────────────────┤
│  [状态栏] 仿真状态 | 连接状态 | 当前时间                      │
└─────────────────────────────────────────────────────────────┘
```

### 左侧控制面板

#### 🎮 仿真控制
- **启动按钮**: 开始仿真（绿色）
- **暂停按钮**: 暂停/恢复仿真（橙色）
- **停止按钮**: 停止仿真（红色）
- **进度条**: 显示仿真进度
- **状态显示**: 当前仿真状态
- **时间显示**: 仿真内部时间

#### 📊 实时指标
四个关键指标卡片：
- **用户满意度**: 用户体验指标（-1到1）
- **运营商利润**: 充电站盈利能力（-1到1）
- **电网友好度**: 对电网影响程度（-1到1）
- **综合评分**: 多目标综合评价（-1到1）

每个指标卡片显示：
- 当前数值
- 变化趋势（↗增长 ↘下降 ━持平）
- 变化百分比

#### ⚙️ 快速配置
- **算法选择**: 调度算法下拉菜单
  - `rule_based`: 基于规则的调度
  - `uncoordinated`: 无序充电（基准）
  - `coordinated_mas`: 协调多智能体系统
  - `marl`: 多智能体强化学习
- **策略选择**: 优化策略
  - `balanced`: 平衡策略
  - `user_first`: 用户优先
  - `profit_first`: 利润优先
  - `grid_first`: 电网优先
- **高级配置**: 打开详细配置对话框

### 右侧内容区域

#### 📊 图表分析标签
1. **区域负载热力图**
   - 显示各区域随时间变化的负载情况
   - 颜色编码：蓝色(低负载) → 红色(高负载)
   - 支持时间范围选择

2. **多指标趋势图**
   - 实时显示四项关键指标的变化趋势
   - 可选择显示/隐藏特定指标
   - 支持Y轴范围调整

3. **用户等待时间分布**
   - 柱状图显示不同等待时间段的用户数量
   - 帮助分析系统服务质量

#### 🗺️ 实时地图标签
- **地图控制栏**
  - 缩放按钮：🔍+ 🔍- 重置
  - 图层控制：显示用户、显示充电桩
- **动态地图显示**
  - 用户图标：圆形，颜色表示状态
    - 🟢 绿色：充电中
    - 🟡 黄色：等待中  
    - 🔵 蓝色：行驶中
    - ⚪ 灰色：空闲
  - 充电桩图标：方形，颜色表示状态
    - 🟢 绿色：可用
    - 🔴 红色：占用中
    - ⚪ 灰色：故障
  - SOC显示：用户旁边显示电量百分比
  - 队列指示：充电桩旁边显示排队人数
- **交互功能**
  - 鼠标悬停显示详细信息
  - 滚轮缩放
  - 拖拽移动视图

#### 📋 数据详情标签
三个数据表格：
1. **用户数据表**
   - 用户ID、状态、电量、位置等
   - 支持排序和筛选

2. **充电桩数据表**
   - 充电桩ID、状态、利用率、收入等
   - 颜色编码表示不同状态

3. **区域数据表**
   - 各区域负载、可再生能源、碳强度等
   - 实时更新区域电网状况

## 🔄 操作流程

### 基础仿真流程

#### 1. 系统启动
```bash
# 启动系统
python launch_ev_simulation.py
```
系统会自动检查：
- ✅ Python版本
- ✅ 依赖包
- ✅ 配置文件
- ✅ 仿真模块

#### 2. 配置设置
在启动仿真前，可以：
- 选择调度算法
- 设置优化策略
- 调整仿真参数（通过高级配置）

#### 3. 启动仿真
1. 点击绿色"启动"按钮
2. 系统开始初始化仿真环境
3. 状态显示变为"运行中"
4. 进度条开始更新

#### 4. 监控过程
- 观察实时指标变化
- 查看地图上的动态变化
- 分析图表趋势
- 检查数据表格

#### 5. 控制仿真
- **暂停**: 临时停止，可恢复
- **停止**: 完全结束，需重新启动
- **速度**: 通过设置调整更新频率

### 高级分析流程

#### 算法对比分析
1. 运行第一种算法并记录结果
2. 停止仿真，切换算法
3. 使用相同配置重新运行
4. 对比关键指标差异
5. 导出数据进行深入分析

#### 参数敏感性分析
1. 固定算法，改变关键参数
2. 记录不同参数下的性能
3. 识别最优参数组合
4. 分析参数对结果的影响

## ⚡ 高级功能

### 🔧 高级配置

通过"高级配置"按钮打开配置对话框：

#### 环境配置
- **仿真天数**: 1-30天
- **用户数量**: 10-10000个
- **充电站数量**: 1-100个
- **每站充电桩数**: 1-50个
- **时间步长**: 1-60分钟

#### 调度配置
- **算法选择**: 四种算法可选
- **优化权重**: 三个目标的权重分配
  - 用户满意度权重
  - 运营商利润权重
  - 电网友好度权重

#### 电网配置
- **电价设置**:
  - 平时电价: 0.1-2.0 元/kWh
  - 峰时电价: 0.1-3.0 元/kWh
  - 谷时电价: 0.1-1.0 元/kWh
- **时段设置**: 可自定义峰谷时段

### 📊 数据导出

支持多种数据导出格式：

#### 导出类型
1. **完整仿真数据** (JSON)
   - 配置信息
   - 实时指标历史
   - 时间序列数据
   - 最终统计结果

2. **指标数据** (CSV)
   - 时间戳
   - 各项指标数值
   - 便于Excel分析

3. **地图快照** (PNG)
   - 当前地图状态
   - 用户和充电桩分布

#### 导出操作
```
文件菜单 → 导出数据 → 选择格式 → 保存位置
```

### 🔄 配置管理

#### 保存配置
```
文件菜单 → 保存 → 选择位置 → config_name.json
```

#### 加载配置
```
文件菜单 → 打开 → 选择文件 → 自动应用配置
```

#### 预设场景
系统内置多种预设场景：
- **正常工作日**: 标准配置
- **节假日高峰**: 更多用户，相同充电桩
- **夜间低负载**: 较少用户
- **设备故障**: 部分充电桩故障

### 🎨 界面自定义

#### 主题切换
- **浅色主题** (默认): 适合白天使用
- **深色主题**: 适合夜间使用，护眼

#### 图表设置
- **更新频率**: 1-10秒可调
- **历史数据**: 保留点数可调
- **颜色方案**: 多种配色可选

## 🔍 故障排除

### 常见问题

#### Q1: 启动时提示"缺少依赖包"
**解决方案**:
```bash
# 升级pip
python -m pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt

# 如果还有问题，逐个安装
pip install PyQt6 pyqtgraph numpy pandas
```

#### Q2: 图表不显示或显示异常
**可能原因**:
- pyqtgraph版本不兼容
- 显卡驱动问题
- Qt环境变量设置

**解决方案**:
```bash
# 重新安装pyqtgraph
pip uninstall pyqtgraph
pip install pyqtgraph==0.13.3

# 设置环境变量
export QT_AUTO_SCREEN_SCALE_FACTOR=1
```

#### Q3: 仿真运行缓慢
**优化建议**:
1. 减少用户数量和充电桩数量
2. 增加时间步长
3. 关闭不必要的可视化功能
4. 确保有足够的系统内存

#### Q4: 数据导出失败
**检查项**:
- 磁盘空间是否充足
- 是否有写入权限
- 文件路径是否包含特殊字符

### 性能优化

#### 系统配置建议
- **CPU**: Intel i5或同等级以上
- **内存**: 8GB RAM推荐
- **显卡**: 支持OpenGL的独立显卡
- **存储**: SSD硬盘提升加载速度

#### 运行参数调优
```python
# 在config.json中调整
{
  "ui": {
    "update_interval_ms": 2000,    // 增加更新间隔
    "chart_max_points": 144,       // 减少图表点数
    "map_refresh_rate": 5000       // 降低地图刷新率
  }
}
```

## 🚀 开发扩展

### 添加新的调度算法

#### 1. 创建算法文件
```python
# algorithms/my_algorithm.py
def schedule(state, config):
    """
    自定义调度算法
    
    Args:
        state: 当前系统状态
        config: 配置参数
        
    Returns:
        decisions: {user_id: charger_id}
    """
    decisions = {}
    # 实现你的算法逻辑
    return decisions
```

#### 2. 注册算法
在`ev_charging_gui.py`中添加：
```python
# 在算法下拉菜单中添加
self.algorithm_combo.addItem("my_algorithm")

# 在配置处理中添加
elif algorithm == "my_algorithm":
    from algorithms.my_algorithm import schedule
    decisions = schedule(state, config)
```

### 添加新的指标

#### 1. 修改指标计算
在`simulation/metrics.py`中添加：
```python
def calculate_new_metric(state, config):
    """计算新指标"""
    # 实现计算逻辑
    return metric_value
```

#### 2. 更新GUI显示
在主窗口中添加新的指标卡片：
```python
self.new_metric_card = MetricCard("新指标", 0.0)
layout.addWidget(self.new_metric_card)
```

### 自定义可视化组件

#### 创建新图表
```python
class CustomChart(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setupUI()
    
    def setupUI(self):
        # 实现UI布局
        pass
    
    def updateData(self, data):
        # 更新数据显示
        pass
```

### 扩展配置选项

在配置对话框中添加新的配置项：
```python
def _createAdvancedTab(self):
    """创建高级配置选项卡"""
    widget = QWidget()
    layout = QFormLayout(widget)
    
    # 添加新的配置项
    self.new_option = QSpinBox()
    layout.addRow("新选项:", self.new_option)
    
    return widget
```

## 📚 参考资料

### 技术文档
- [PyQt6官方文档](https://doc.qt.io/qtforpython/)
- [pyqtgraph文档](https://pyqtgraph.readthedocs.io/)
- [NumPy文档](https://numpy.org/doc/)
- [Pandas文档](https://pandas.pydata.org/docs/)

### 算法参考
- 多智能体系统理论
- 强化学习基础
- 电网调度优化
- 电动汽车充电策略

### 相关论文
1. "Multi-Agent Systems for EV Charging Coordination"
2. "Reinforcement Learning in Smart Grid Applications" 
3. "Electric Vehicle Charging Optimization"

## 📞 技术支持

### 问题反馈
如遇到问题，请提供：
1. 系统信息（操作系统、Python版本）
2. 错误信息截图
3. 操作步骤描述
4. 配置文件内容

### 功能建议
欢迎提出改进建议：
- 新的调度算法
- 界面优化建议
- 性能改进方案
- 新功能需求

---

**版本**: 1.0  
**更新日期**: 2025年1月  
**作者**: EV Simulation Team

> 本系统为电动汽车充电调度研究提供了强大的仿真和分析平台。通过直观的界面和丰富的功能，帮助研究人员和工程师深入理解充电调度策略的影响，推动智能充电技术的发展。
